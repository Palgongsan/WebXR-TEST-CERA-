<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Model Viewer AR - Product Preview (AR auto-play animation)</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    /* PATCH NOTES:
       - Purpose: Lock AR scale, disable preview zoom, and auto-play preferred animation upon AR entry.
       - Rollback: remove attributes `disable-zoom` and `ar-scale="fixed"`, and remove the script block at the end.
    */
    :root { --preview-bg: #111; }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--preview-bg);
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      color: #e8eef8;
    }

    model-viewer {
      width: 90vw;
      height: 80vh;
      max-width: 1200px;
      max-height: 900px;
      border-radius: 12px;
      box-shadow: 0 6px 30px rgba(0,0,0,.6);
      background: #121212;
      display: block;
    }

    .hint {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: rgba(255,255,255,0.9);
      font-size: 13px;
      background: rgba(0,0,0,0.4);
      padding: 6px 10px;
      border-radius: 999px;
      pointer-events: none;
      user-select: none;
    }
  </style>
</head>
<body>
  <!--
    Notes:
    - Replace model.glb with your actual GLB filename if different.
    - This file keeps your UI minimal and intact, and adds logic to autoplay the preferred animation
      (CERA_V11_CylinderAction(240)_Baked) when AR session/object-placement occurs.
  -->
  <model-viewer
    id="mv"
    src="model2.glb"
    alt="Product Preview"
    ar
    ar-modes="webxr scene-viewer quick-look"
    camera-controls
    disable-zoom
    ar-scale="fixed"
    auto-rotate
    exposure="1"
    style="touch-action: none;">
    <div class="hint">Tap the AR button to place the product in your space</div>
  </model-viewer>

  <!-- ===== AR-mode animation controls (붙여넣기) ===== -->
<style>
  /* AR 컨트롤 오버레이 (AR 모드에서 나타남) */
  #arAnimControls {
    position: fixed;
    right: 18px;
    bottom: 18px;
    width: 240px;
    background: rgba(6,10,14,0.95);
    border: 1px solid rgba(255,255,255,0.06);
    color: #e6eef8;
    padding: 12px;
    border-radius: 12px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.6);
    z-index: 9999;
    display: none; /* 기본 숨김 */
    font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
  }
  #arAnimControls h5 { margin:0 0 8px 0; font-size:13px; color:#9fb3d9; }
  #arAnimControls select, #arAnimControls button { width:100%; margin-top:6px; font-size:14px; }
  #arAnimControls .row { display:flex; gap:8px; margin-top:8px; }
  #arAnimControls .row button { flex:1; padding:8px; border-radius:8px; border:none; cursor:pointer; }
  .btn-play { background:#1976d2; color:white; }
  .btn-pause { background:#2b2f36; color:white; }
  #arAnimControls small { color:#9fb3d9; display:block; margin-top:6px; font-size:12px; }
</style>

<div id="arAnimControls" aria-hidden="true">
  <h5>AR Animation</h5>
  <label for="arAnimSelect" class="sr-only">Choose animation</label>
  <select id="arAnimSelect" aria-label="Choose animation">
    <!-- 기본 옵션: 네가 알려준 3개 -->
    <option value="CERA_V11_ChairMode(1)_Baked">CERA_V11_ChairMode(1)_Baked</option>
    <option value="CERA_V11_CylinderAction(240)_Baked">CERA_V11_CylinderAction(240)_Baked</option>
    <option value="CERA_V11_Stretch(1)_Baked">CERA_V11_Stretch(1)_Baked</option>
  </select>

  <div class="row">
    <button id="arPlayBtn" class="btn-play" type="button">Play</button>
    <button id="arPauseBtn" class="btn-pause" type="button">Pause</button>
  </div>

  <small id="arCtrlInfo">Enter AR and place the object to enable playback.</small>
</div>

<script>
(function(){
  const mv = document.getElementById('mv') || document.querySelector('model-viewer');
  if (!mv) {
    console.warn('AR animation controls: <model-viewer id="mv"> not found.');
    return;
  }

  // UI elements
  const panel = document.getElementById('arAnimControls');
  const sel = document.getElementById('arAnimSelect');
  const playBtn = document.getElementById('arPlayBtn');
  const pauseBtn = document.getElementById('arPauseBtn');
  const info = document.getElementById('arCtrlInfo');

  // 기본 동작: 선택된 애니메이션을 model-viewer에 설정하고 재생/일시정지
  function enablePanel() {
    panel.style.display = 'block';
    panel.setAttribute('aria-hidden', 'false');
  }
  function disablePanel() {
    panel.style.display = 'none';
    panel.setAttribute('aria-hidden', 'true');
  }

  function getSelectedAnim() {
    return sel.value;
  }

  function applyAnimation(name) {
    try {
      // set animation-name attribute (model-viewer 표준 방식)
      mv.setAttribute('animation-name', name);
      console.log('[AR-Ctrl] set animation-name:', name);
    } catch (e) {
      console.warn('[AR-Ctrl] set animation-name failed:', e);
    }
  }
  function playAnimation(name) {
    applyAnimation(name);
    try {
      mv.play();
      console.log('[AR-Ctrl] play requested:', name);
      info.textContent = 'Playing: ' + (name || '(unnamed)');
    } catch (e) {
      console.warn('[AR-Ctrl] play() failed:', e);
      info.textContent = 'Play failed — see console.';
    }
  }
  function pauseAnimation() {
    try {
      mv.pause();
      console.log('[AR-Ctrl] pause requested');
      info.textContent = 'Paused';
    } catch (e) {
      console.warn('[AR-Ctrl] pause() failed:', e);
      info.textContent = 'Pause failed — see console.';
    }
  }

  // 버튼 이벤트
  playBtn.addEventListener('click', ()=> {
    const name = getSelectedAnim();
    playAnimation(name);
  });
  pauseBtn.addEventListener('click', ()=> pauseAnimation());

  // AR 상태에 따라 패널 보이기/숨기기
  // model-viewer가 트리거하는 이벤트 활용 (브라우저/버전에 따라 evt.detail 내용이 조금 다를 수 있음)
  mv.addEventListener('ar-status', (evt) => {
    const status = evt?.detail?.status ?? evt?.detail ?? null;
    console.log('[AR-Ctrl] ar-status', status, evt);
    if (status === 'session-started' || status === 'object-placed') {
      enablePanel();
      // 만약 자동으로 선택된 애니를 재생하고 싶다면 여기에 호출
      // playAnimation(getSelectedAnim());
    } else {
      disablePanel();
    }
  });

  // WebXR 안전망 (enter-vr)
  mv.addEventListener('enter-vr', () => {
    console.log('[AR-Ctrl] enter-vr');
    enablePanel();
  });
  // 세션 종료시 숨기기
  mv.addEventListener('exit-vr', () => {
    console.log('[AR-Ctrl] exit-vr');
    disablePanel();
  });

  // Quick Look(ios) 버튼 탭에 대한 best-effort
  mv.addEventListener('quick-look-button-tapped', () => {
    console.log('[AR-Ctrl] quick-look-button-tapped');
    // Quick Look은 네이티브 뷰어라 제어가 제한될 수 있으니 UI만 표시해둠
    // (실제 재생 제어가 안 될 수 있으므로 사용자에게 안내)
    enablePanel();
    info.textContent = 'iOS Quick Look — playback control may be limited.';
  });

  // 옵션: model-viewer가 제공하는 애니메이션 목록이 있으면 select를 갱신
  const avail = mv.availableAnimations ?? (typeof mv.getAvailableAnimations === 'function' && mv.getAvailableAnimations());
  if (avail && Array.isArray(avail) && avail.length > 0) {
    // 기존 옵션 대체
    sel.innerHTML = '';
    avail.forEach((name, idx) => {
      const opt = document.createElement('option');
      opt.value = name || `anim_${idx}`;
      opt.textContent = (name && name.length) ? name : `anim_${idx}`;
      sel.appendChild(opt);
    });
    console.log('[AR-Ctrl] populated from mv.availableAnimations', avail);
  } else {
    // fallback: leave the hardcoded options (you provided them)
    console.log('[AR-Ctrl] availableAnimations not present — using hardcoded list');
  }

  // UX: 만약 AR 진입 시 자동 재생을 원하면 아래 주석 해제
  // mv.addEventListener('object-placed', () => playAnimation(getSelectedAnim()));

})();
</script>
<!-- ===== end AR-mode animation controls ===== -->


  <!-- AR auto-play animation script: keeps existing UI and only injects behavior on AR entry -->
  <script>
    // --- 설정: 재생할 애니메이션 이름 (사용자 제공)
    const PREFERRED_ANIM = "CERA_V11_CylinderAction(240)_Baked";

    const mv = document.querySelector('#mv') || document.querySelector('model-viewer');

    if (!mv) {
      console.warn('model-viewer element not found. Make sure <model-viewer id="mv"> exists.');
    } else {
      // 시도해서 재생하는 함수
      function playPreferredAnimation() {
        try {
          const avail = mv.availableAnimations ?? mv.getAvailableAnimations?.();
          if (avail && Array.isArray(avail) && !avail.includes(PREFERRED_ANIM)) {
            console.warn('Preferred animation not found in availableAnimations:', PREFERRED_ANIM, avail);
            // 하지만 일부 환경에서는 이름 일치없이도 작동할 수 있으므로 시도해봄
          }
          mv.setAttribute('animation-name', PREFERRED_ANIM);
          // 짧은 크로스페이드를 원하면 아래 주석을 해제하고 값(ms)를 설정
          // mv.setAttribute('animation-crossfade-duration','100');
          mv.play();
          console.log('Requested to play animation:', PREFERRED_ANIM);
        } catch (err) {
          console.error('playPreferredAnimation error:', err);
        }
      }

      // model-viewer의 AR 상태 이벤트를 사용한 트리거
      mv.addEventListener('ar-status', (evt) => {
        // evt.detail.status는 버전/플랫폼에 따라 다를 수 있음
        const status = evt?.detail?.status ?? evt?.detail ?? null;
        console.log('ar-status event:', status, evt);
        // session-started 또는 object-placed에서 재생 시도
        if (status === 'session-started' || status === 'object-placed') {
          playPreferredAnimation();
        }
      });

      // WebXR (enter-vr) 안전망
      mv.addEventListener('enter-vr', () => {
        console.log('enter-vr detected — attempting to play preferred animation');
        playPreferredAnimation();
      });

      // iOS Quick Look 버튼 탭(가능하면)
      mv.addEventListener('quick-look-button-tapped', () => {
        console.log('quick-look-button-tapped — best effort to play animation');
        // iOS Quick Look에서 외부 제어가 제한적일 수 있으나 시도함
        playPreferredAnimation();
      });

      // scene-graph-ready 시 (선택적 초기화)
      mv.addEventListener('scene-graph-ready', () => {
        console.log('scene-graph-ready');
        // 필요하면 미리 애니메이션 이름 셋업 가능:
        // mv.setAttribute('animation-name', PREFERRED_ANIM);
      });

      // 디버깅 로그: play, pause 이벤트
      mv.addEventListener('play', (e) => console.log('model-viewer play event', e));
      mv.addEventListener('pause', (e) => console.log('model-viewer pause event', e));
      mv.addEventListener('error', (e) => console.error('model-viewer error', e));
    }
  </script>
</body>
</html>
