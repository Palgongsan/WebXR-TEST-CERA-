<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Model Viewer AR - Product Preview (AR auto-play animation)</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    /* PATCH NOTES:
       - Purpose: Lock AR scale, disable preview zoom, and auto-play preferred animation upon AR entry.
       - Rollback: remove attributes `disable-zoom` and `ar-scale="fixed"`, and remove the script block at the end.
    */
    :root { --preview-bg: #111; }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--preview-bg);
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      color: #e8eef8;
    }

    model-viewer {
      width: 90vw;
      height: 80vh;
      max-width: 1200px;
      max-height: 900px;
      border-radius: 12px;
      box-shadow: 0 6px 30px rgba(0,0,0,.6);
      background: #121212;
      display: block;
    }

    .hint {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: rgba(255,255,255,0.9);
      font-size: 13px;
      background: rgba(0,0,0,0.4);
      padding: 6px 10px;
      border-radius: 999px;
      pointer-events: none;
      user-select: none;
    }
  </style>
</head>
<body>
  <!--
    Notes:
    - Replace model.glb with your actual GLB filename if different.
    - This file keeps your UI minimal and intact, and adds logic to autoplay the preferred animation
      (CERA_V11_CylinderAction(240)_Baked) when AR session/object-placement occurs.
  -->
  <model-viewer
    id="mv"
    src="model2.glb"
    alt="Product Preview"
    ar
    ar-modes="webxr scene-viewer quick-look"
    camera-controls
    disable-zoom
    ar-scale="fixed"
    auto-rotate
    exposure="1"
    style="touch-action: none;">
    <div class="hint">Tap the AR button to place the product in your space</div>
  </model-viewer>

  <!-- AR auto-play animation script: keeps existing UI and only injects behavior on AR entry -->
  <script>
    // --- 설정: 재생할 애니메이션 이름 (사용자 제공)
    const PREFERRED_ANIM = "CERA_V11_CylinderAction(240)_Baked";

    const mv = document.querySelector('#mv') || document.querySelector('model-viewer');

    if (!mv) {
      console.warn('model-viewer element not found. Make sure <model-viewer id="mv"> exists.');
    } else {
      // 시도해서 재생하는 함수
      function playPreferredAnimation() {
        try {
          const avail = mv.availableAnimations ?? mv.getAvailableAnimations?.();
          if (avail && Array.isArray(avail) && !avail.includes(PREFERRED_ANIM)) {
            console.warn('Preferred animation not found in availableAnimations:', PREFERRED_ANIM, avail);
            // 하지만 일부 환경에서는 이름 일치없이도 작동할 수 있으므로 시도해봄
          }
          mv.setAttribute('animation-name', PREFERRED_ANIM);
          // 짧은 크로스페이드를 원하면 아래 주석을 해제하고 값(ms)를 설정
          // mv.setAttribute('animation-crossfade-duration','100');
          mv.play();
          console.log('Requested to play animation:', PREFERRED_ANIM);
        } catch (err) {
          console.error('playPreferredAnimation error:', err);
        }
      }

      // model-viewer의 AR 상태 이벤트를 사용한 트리거
      mv.addEventListener('ar-status', (evt) => {
        // evt.detail.status는 버전/플랫폼에 따라 다를 수 있음
        const status = evt?.detail?.status ?? evt?.detail ?? null;
        console.log('ar-status event:', status, evt);
        // session-started 또는 object-placed에서 재생 시도
        if (status === 'session-started' || status === 'object-placed') {
          playPreferredAnimation();
        }
      });

      // WebXR (enter-vr) 안전망
      mv.addEventListener('enter-vr', () => {
        console.log('enter-vr detected — attempting to play preferred animation');
        playPreferredAnimation();
      });

      // iOS Quick Look 버튼 탭(가능하면)
      mv.addEventListener('quick-look-button-tapped', () => {
        console.log('quick-look-button-tapped — best effort to play animation');
        // iOS Quick Look에서 외부 제어가 제한적일 수 있으나 시도함
        playPreferredAnimation();
      });

      // scene-graph-ready 시 (선택적 초기화)
      mv.addEventListener('scene-graph-ready', () => {
        console.log('scene-graph-ready');
        // 필요하면 미리 애니메이션 이름 셋업 가능:
        // mv.setAttribute('animation-name', PREFERRED_ANIM);
      });

      // 디버깅 로그: play, pause 이벤트
      mv.addEventListener('play', (e) => console.log('model-viewer play event', e));
      mv.addEventListener('pause', (e) => console.log('model-viewer pause event', e));
      mv.addEventListener('error', (e) => console.error('model-viewer error', e));
    }
  </script>
</body>
</html>
